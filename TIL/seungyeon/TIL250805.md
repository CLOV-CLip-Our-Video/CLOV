# 📅 TIL - 2025-08-05

## 📌 오늘 한 일

### CLOV 프로젝트 - WebRTC 음성 채팅 기능 개발
- **Mesh 방식 WebRTC 음성 채팅 구현**
  - 마이크 on/off 상태를 canvas-sync 이벤트에 포함하여 참가자 간 동기화
  
- **음성 볼륨 시각화 컴포넌트 구현**
  - `VoiceVolumeBar` 컴포넌트로 세로형 실시간 음성 레벨 표시
  - 색상 변화(초록→노랑→주황→빨강)로 볼륨 단계 시각화
  - 피크 인디케이터 및 말하는 중 감지 애니메이션 효과
  
- **UI/UX 개선**
  - 카메라/마이크 버튼을 그라디언트 스타일로 재디자인
  - VideoPreview와 VolumeBar를 나란히 배치하는 레이아웃 구현
  - 마이크 상태 아이콘을 ParticipantList에 추가

- **오디오 품질 최적화**
  - getUserMedia 오디오 제약조건 최적화 (AGC 비활성화가 핵심)
  - 환경별(studio/quiet/normal/noisy) 오디오 설정 프리셋 구현
  - 실시간 오디오 품질 모니터링 시스템 개발

---

## 📖 오늘 새롭게 배운 내용

### 🎤 **WebRTC 오디오 처리 핵심 개념**
> getUserMedia의 오디오 제약조건이 음질에 미치는 영향

**AGC(Auto Gain Control) 비활성화의 중요성:**
```javascript
// 음질 나쁨
audio: {
  autoGainControl: true,  // AGC가 음질을 망침!
  sampleRate: 48000,
}

// 음질 개선  
audio: {
  sampleRate: { ideal: 48000, min: 44100 },
  sampleSize: { ideal: 24 },
  autoGainControl: { ideal: false },  // 핵심!
  echoCancellation: { ideal: false }, // 조용한 환경에서
}
```

### 🎵 **MediaStream과 MediaStreamTrack 구조**

```javascript
// MediaStream = 앨범 (컨테이너)
// MediaStreamTrack = 곡 (실제 데이터)
const stream = await getUserMedia({ video: true, audio: true });
const audioTrack = stream.getAudioTracks()[0]; // 첫 번째 오디오 트랙
audioTrack.enabled = false; // 트랙 비활성화 (음소거)
```

**핵심 깨달음:**
- 트랙은 "공간"이 아니라 "실제 미디어 데이터"
- 각 사용자는 독립적인 스트림을 가짐
- `track.enabled`로 제어하는 것이 `addTrack`보다 효율적

### 🔄 **상태 동기화 패턴**
> RoomInfo와 RecordingCanvas 모두에서 마이크 상태 전송 필요

**문제:** 투명도/크기 조절 시 마이크 상태가 동기화되지 않음
**원인:** `updateMyState`와 `updateMyPosition`에 `isMicOn` 누락
**해결:**
```javascript
const updatedState = {
  ...currentState,
  scale: size / 100,
  opacity: transparency / 100,
  mode: cameraMode,
  filter: selectedFilter?.name || null,
  isMicOn: isMicOn, // 🆕 추가!
};
```
