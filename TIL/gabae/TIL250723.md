# TIL 250723

## 오늘 한 일 : 프로젝트 관련
- CI/CD : Jenkins에서 GitLab 연동 설정 진행
    - 해보고싶었던건데 예린이와 함께 설정 완!!
    - 까먹을까봐 노션 워크북에 정리해 놓음
- Redis 상태 저장 구조 정리 및 테스트 진행
    - RedisCanvasRepositoryTest, RedisRepositoryTest를 분리하여 책임별 테스트 설계
    - 레디스 구조를 계속 며칠 동안 조금씩 바꿨는데 오늘 내가 생각한게 지금으로 최선같음
    * 아래와 같이 확정함

| Redis 키                        | 설명                    | 저장 방식           | 예시                                                                       |
| ------------------------------ | --------------------- | --------------- | ------------------------------------------------------------------------ |
| `canvas:{roomCode}:state`      | 클라이언트별 위치/스케일/불투명도 상태 | Hash            | `canvas:testRoom:state` <br>→ field: `clientId`, value: `CanvasStateDto` |
| `canvas:{roomCode}:nickname`   | 클라이언트별 닉네임            | Hash            | `canvas:testRoom:nickname` <br>→ field: `clientId`, value: `"참여자1"`      |
| `canvas:{roomCode}:background` | 방의 배경 정보              | String (직렬화 객체) | `canvas:testRoom:background` <br>→ value: `BackgroundDto` 객체             |
| `{roomCode}:host`              | 방의 호스트 ID 저장          | String          | `testRoom:host` <br>→ value: `"hostClientId"`                            |
| `{roomCode}`                   | TTL 유지용 키             | String          | `testRoom` <br>→ value: `"active"` (만료 시간 설정됨)                           |


- 예린이와 논의...끙
    - 레디스 저장 로직Redis에 값 세팅을 Service단에서 할지, WebSocket 연결하고 해야하는지 어제 생각해본 내용을 같이 나눴음해서 얘기하자고함
    - 방 상태 초기값, 참여자 초기값 등... 초기값은 서비스단에서, 갱신과 실시간 동기화를 위해 값 바꾸는건 소켓을 통해!
    - isHost가 RDB에 있고, 방 생성과 참여 시 응답으로 넘겨주는데 Redis에는 필요한가?에 대한 고민 완 -> 있어야함

- 팀원들에게 api, 웹소켓..등 흐름 설명
- 프론트엔드 팀원들한테 프론트엔드 워크북 노션 제안
    - 백엔드는 백엔드 워크북 노션 유용하게 쓰고 있어서..!!!


## 오늘 배운 것, 고민
### Jenkins에서 트러블 슈팅
- 멀티 모듈/멀티 디렉토리 구조일 경우 Jenkinsfile 내에서 빌드 경로를 명시적으로 설정하는 것이 중요
    - 즉, 폴더 구조가 backend/, frontend/로 나뉜 경우 빌드 경로 자동 인식되지 않아 스크립트 수동 수정 필요
    - 우리 프젝 레포에는 백엔드, 프론트엔드 코드 둘 다 있어서!
- 설정 다하고 빌드 테스트하는데, 빌드 실패
- 실패1) ./gradlew: Permission denied 이슈 발생
    - Gradle 실행 파일인 gradlew에 실행 권한이 없어서 생기는 오류
    - 해결
        - Linux나 Mac 환경에서는 `.sh`, `.gradlew` 같은 스크립트 파일은 직접 실행하려면 실행 권한이 있어야한다고해서 아래 추가
        - sh 'chmod +x gradlew', sh './gradlew clean build'
- 이렇게 설정하고도 빌드 실패
- 실패2) 도커 컨테이너 내부에 jdk가 없어서 발생
    - 해결
        - 도커 컨테이너 내에 jdk 설치
- 또 빌드 실패
- 실패3) 테스트 코드가 안 돌아가는게 있어서 실패
    - sh './gradlew clean build -x test'로 해결
- 실패4) /var/jenkins_home/workspace/clov/frontend@tmp/durable-3a6ed8f7/script.sh.copy: 1: npm: not found
    - 프론트엔드 코드도 지금 있는데, npm이 도커 내에 없어서 install
- 이렇게까지 했는데 jenkins를 dokcer  embedding 해서 사용했는데, docker -compose에 등록하고, ec2 instance drive 에 mount해줘야해서 docker-compose.yml 수정(feat.은재)
    - 그러다가 날린 은재...
- 다음에도 설정이 날라갈 수 있으므로..매번 jdk 다시깔고, nodejs 다시깔고 하면 문제가있음..!!
    - 도커 파일 생성!!!!
- 이제 진짜 끝..인줄 알았는데
    - 빌드 한 후에, 다른 docker들을 재실행해줘야 잘 반영!!
    - 그럴려면? 젠킨스 docker 내부에서도 docker-compose를 실행시킬 수 있어야함!!!(이것도 feat.은재)
- 레디스 코드 커밋하고 merge해서 빌드 잘 되나 봤는데 안되는 문제 발견
    - 젠킨스에서 Trigger - Enable GitLab triggers에 Push Events, Opend Merge Request Events 체크 빠져있었어서.. 이거 체크해주니까 성공적~~~휴

### Redis 키 관리와 TTL 기반 만료 구조
- TTL(Time To Live)은 전체 키에 대해 설정 가능하며, 특정 시간이 지나면 자동으로 삭제되어 메모리 효율 관리에 도움을 줌
    - 예: redisTemplate.expire(key, Duration.ofMinutes(30))
- TTL이 만료되기 전에 사용자가 직접 나간 경우, 명시적으로 해당 키를 삭제(DEL)하거나 필드를 제거(HDEL)해야 함

### Redis CLI를 통한 실시간 데이터 상태 확인
```
# Canvas 상태 (모든 참여자의 위치 상태)
HGETALL canvas:testRoom:state

# 닉네임 정보
HGETALL testRoom:nickname

# 방장 ID 확인
GET testRoom:host

# 배경 정보 (JSON String으로 저장되어 있음)
GET canvas:testRoom:background

# TTL확인하는거!@
TTL testRoom

# 모든 키 확인
keys *

# 레디스에 저장된거 다 ~~ 삭제
FLUSHALL
```

## 내일 할 일
- 웹소켓 이벤트 분기 처리 코드 작성
    - join_room, leave_room..카메라 녹화 시작, 상태 갱신 등...
- WebSocket 이벤트 명세 문서 작성
    - 프론트엔드와의 공유 목적
    - 클라이언트가 서버로 보내야 하는 요청 형태와, 서버로부터 받게 될 응답 형태(JSON 구조)를 정리한 문서 작성
- ffmpeg...에 대해 알아보자..
