# TIL 250807

## 오늘 한 일
- 방 위임 관련 웹 소켓 이벤트 추가
- CLOV 프로젝트 성능 테스트 대시보드 찐으로 최종 구축 완료
- load-test.js, spike-test.js 작성 완료    

## 오늘의 배운점/생각
### 1. MySQL Exporter 연동 및 이슈 해결
- prom/mysqld-exporter를 도커에 구성하여 Prometheus로 지표 수집 성공.
- 초기에 권한 부족 오류 발생 root로 접속해서 MySQL Exporter 필요 권한 추가
- 사실 이 연동을 오늘 처음 시도한게 아니라...실패했었는데 알고보니까 처음엔 환경변수로 시도해서 실패한거였고, Command 방식으로 변경해서 성공함!
- 아무튼 docker-compose...랑 Prometheus 설정 수정해서 최종적으로 그라파나에 연동 함 ㅜㅜ 다 하고보니 쉬운건데...
- - MySQL Uptime, QPS (초당 쿼리 수), Connection 수, Thread 활동,InnoDB Buffer Pool 사용률,Slow Query 수, Table Lock 상태, Network Traffic, Memory 사용량 등 MySQL 내부 상태를 상세하게 시각화할 수 있음.
- 아 이슈가 또 있었는데,MySQL Slow Query Log에 MySQL Exporter 쿼리가 기록되는 문제가 있었음
    - `log_queries_not_using_indexes = ON`설정 때문에:
    - 실행 시간과 관계없이 **인덱스를 사용하지 않는 모든 쿼리**가 slow.log에 기록됨
    - `information_schema` 테이블들은 시스템 메타데이터 테이블이라 일반적인 인덱스가 없음
    - MySQL Exporter의 0.0002초짜리 빠른 쿼리도 slow.log에 기록됨
    - 해당 설정을 off해주면 됨!
- cf)
    - DB 내부의 커넥션 수, 쿼리 실행량, 슬로우 쿼리 여부 등 운영 성능을 수치로 보기 위해 exporter를 붙였다.
    - 단순한 DB 사용 유무가 아니라, 어떤 요청이 얼마나 자주, 얼마나 느리게 처리되는지를 수치로 보면서 병목 지점을 찾고 싶었다.
    - 특히 k6 부하 테스트 결과를 해석할 때, DB 연결 개수나 처리 속도와 연계해 확인할 수 있다는 점이 실무에서도 매우 유용하다고 느꼈다.

### 2. Redis 모니터링
- redis_exporter는 사용하지 않고, Grafana Redis Data Source 플러그인으로 직접 연결.
- redis-dev 컨테이너의 IP 및 포트를 사용해 연결 완료.
- TTL, 연결 클라이언트 수, 명령 처리 시간, 메모리 사용량, slow 쿼리 등 확인 가능.
- Redis 상태 확인용으로 충분히 실용적이며, 실시간 command 처리량도 확인 가능했음
- cf)
    - Exporter 없이도 Redis 상태를 실시간으로 파악할 수 있다는 점에서 간단하지만 효과적인 접근이었다.
    - Pub/Sub 기반 구조나 TTL 기반 캐시 구조를 운영하면서, Redis의 메모리 사용량, 명령 통계, 연결 수 등을 바로 확인할 수 있는 환경을 만든 점이 만족스러웠다.
    - 특히 get, hset, psubscribe 등 명령별 호출 통계를 시각화하면서, 우리 시스템이 어떤 방식으로 Redis를 사용하는지도 더 잘 이해하게 됐다.
### 3. Node Exporter를 통한 서버 리소스 모니터링
- prom/node-exporter를 사용하여 EC2 서버의 CPU/Memory/Disk/Net 상태 수집.
- Grafana에서 다양한 시스템 레벨 지표 대시보드 연동 완료.
- CPU Load, Memory 사용량, 디스크 I/O, 네트워크 트래픽 등 서버 상태 전반을 실시간 분석 가능.
- cf)
    - 서버 CPU, 메모리, 디스크 I/O와 네트워크 사용량을 종합적으로 보기 위해 구성했다.
    - 단순히 "느린데 왜 느릴까?"라고 고민하는 대신, 실제 하드웨어 자원이 부족한지 바로 확인할 수 있다는 점에서 필수적이라고 느꼈다.
    - 특히 부하 테스트 중 CPU 사용률이나 디스크 I/O가 급증하는 구간을 실시간으로 보면서, 테스트 환경 튜닝이나 자원 증설 여부를 판단할 수 있어 유의미했다.

### 4. Spring Boot (Micrometer + Prometheus) 애플리케이션 모니터링
- Spring Boot 3.x + Actuator + Micrometer 구성으로 애플리케이션 상태 수집.
- Grafana에 연동하여 다음 항목 모니터링:
- JVM Heap/GC, HikariCP 커넥션 풀 상태, HTTP 요청 처리 속도, 로그백 로그 수 등
- cf)
    - GC 동작, 메모리 사용량, HikariCP 커넥션 풀 상태 등 Spring 기반 시스템 내부의 세부 동작을 확인할 수 있어서 유용했다.
    - 단순 로그로는 캐치하지 못했던 GC 빈도나 커넥션 풀 고갈 여부를 눈으로 확인할 수 있어서, 실제 운영에서 JVM 튜닝이나 스레드 관리까지 이어질 수 있는 기반을 마련한 셈이다.
### 5. k6 + InfluxDB + Grafana로 성능 테스트 시각화
- 응답 시간(P95/P90), 성공률, 실패률, 최대 RPS, 요청 총 수 등
- 시나리오 기반 테스트로 실제 서비스와 유사한 부하 구성
- cf)
    - 부하 테스트의 수치를 눈으로 직관적으로 확인하고, 병목 구간을 빠르게 탐색하기 위해 구성했다.
    - 단순 CLI 결과만으로는 놓칠 수 있는 요청 성공률, 응답 시간의 변동, RPS 등을 그래프 단위로 확인하면서 테스트 설계의 완성도를 높일 수 있었다.
    - 또한 각 API별 요청 수와 실패율, 응답 시간까지 추적이 가능해져, 실제 서비스 안정성과 성능 병목을 한눈에 진단할 수 있었다.

## 느낀점
- 단순 지표 수집이 아니라, 다각도로 모니터링 가능하게 설계함으로써 병목 지점 식별이 매우 수월해졌다~~
- Spring Boot + Micrometer의 JVM, 커넥션 풀 통계까지 가져오면서 애플리케이션-DB-서버 전구간 모니터링 체계를 완성!!
- 성능 테스트와 운영 관측은 결국 연계된 데이터 흐름 전체를 보는 시각이 중요하다는 것을 체감했다..하하
- 간단하게 load-test만 돌려봤는데 load도 다시 하고(mysql대시보드 연결 전, 오늘 추가된 api있음 이슈로) spike, endurance도 각각 다시 할 예정
- **...웹소켓은 어떻게 테스트하지...

## 내일 할 일
- 중간 평가하고 아마.. 테스트 좀 돌리고 내일 모레 코테라서 공부 살짝 할것 같다