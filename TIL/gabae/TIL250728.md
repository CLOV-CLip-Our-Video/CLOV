# TIL 250728

## 오늘 한 일 : 프로젝트 관련
- APM -> prometheus, grafana, promtail, loki 도입
    - 툴을 뭘로 쓸지 비교하면서 결정
    - Spring Boot 로그를 JSON 포맷으로 출력
    - Promtail 설정 및 로그 수집기 도입
    - Loki 설정 및 로그 수집 저장소 구성
    - Grafana + Prometheus 연동 -> 로그 뜨는 것만 확인하고 시각화 아직 제대로 못함

## 오늘 배운 것, 고민
- 우리 서비스는 실시간 영상, 참여자 상태, 이벤트 동기화 등 복잡한 실시간 통신 흐름과 사용자 활동 로그가 얽혀 있어, 관측성과 장애 분석이 매우 중요
    - ELK와 prometheus, grafana, promtail, loki 중에 뭘 쓸지 고민했음
    - ELK는 구조상 무겁고, 장기적으로 비용이 급증하며, 운영 유지보수도 어렵기 때문에, Loki 기반의 경량화된 로그 시스템이 적합하다고 생각
    - 그 외에도... 쓰려고 했던 PINPOINT : 무거움....이슈로 서버 하나에 더 띄워야한다는 사실을..알게됨,  Scouter는 UI가 너무 올드한 이슈...
- 처음 설정할 때 logback-spring.xml설정 때문에 아예 빌드가 안됐음
    - LogstashConsoleAppender는 사용하면 안됐음..
        - 해당 클래스는 실제 사용도 거의 없고, 대부분의 공식 예제도 ConsoleAppender + LogstashEncoder 조합을 쓴다고해서 이걸로 바꾸니까 바로 됨.

### 모니터링 설정 하면서 배운 것
1. Spring Boot JSON 로그 구성 방법
- logstash-logback-encoder를 활용해 로그를 JSON 형식으로 출력하는 방법을 익힘.
- logback-spring.xml에서 콘솔 및 파일 로그를 JSON 포맷으로 설정.
- 로그가 logs/app.json.log로 저장되도록 파일 롤링 정책 적용.

2. Promtail을 이용한 로그 수집
- Spring Boot에서 출력한 JSON 로그를 promtail을 통해 수집하는 구조를 구성함.
- 도커 컨테이너로 띄운 promtail이 호스트의 로그 디렉터리를 마운트하여 읽도록 설정.
- Redis, Nginx, App 로그 각각 따로 수집 경로 구성.

3. Loki 설정 및 로그 저장
- loki를 Docker로 실행하고 loki-config.yml 설정 파일을 통해 retention(7일), 저장 방식(filesystem)을 구성.
- curl http://localhost:3100/ready로 Loki 정상 기동 여부 확인법도 학습.

4. Prometheus와 Grafana를 통한 메트릭 수집 및 시각화
- spring-boot-starter-actuator, micrometer-registry-prometheus 의존성 추가.
- Prometheus → Grafana로 연동하여 애플리케이션 상태 시각화 대시보드 구축 가능하게 구성.
- 아 grafana 데이터소스에서 쿼리 설정을 해도 로그가 안 뜨길래 왜인가 봤는데, loki를 http로 해줘야하는데 https로 설정해놓아서 해당 설정 바꾸니까 떴음!!

## 내일 할 일
- 그라파나 시각화 어떤식으로 할지 결정
- 소켓쪽이랑 시그널링 서버, 미디어파이프쪽 프론트랑 같이 보기..
- TTL 만료 시 방 전체 정보 지우는거 오늘 못했는데 내일 하기