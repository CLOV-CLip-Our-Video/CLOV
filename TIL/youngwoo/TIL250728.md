# TIL - 2025년 7월 28일

## useCamera 훅의 하드 토글 기능 구현

### 문제 상황

- 카메라나 마이크를 완전히 끄고 켜는 기능이 필요했음
- 기존 `enabled` 속성만 변경하는 것은 소프트 토글로, 리소스는 계속 점유 상태
- 사용자가 진짜 카메라를 껐다가 켜는 기능을 원함
-

### 해결 과정 - useCamera.js 수정

```js
// 카메라 완전히 끄기
const hardToggleCamera = async () => {
  if (currentStream) {
    /* console.log("[useCamera] 하드 OFF 실행"); */
    stopCamera();
  } else {
    /* console.log("[useCamera] 하드 ON 실행"); */
    await startCamera();
  }
};

// 마이크 완전히 끄고 켜기
const stopMic = () => {
  const audioTrack = streamRef.current
    ?.getAudioTracks()
    .find((t) => t.kind === "audio");
  if (audioTrack) {
    streamRef.current?.removeTrack(audioTrack);
    audioTrack.stop();
    setAudioEnabled(false);
  }
};

const startMic = async () => {
  try {
    const newAudioStream = await navigator.mediaDevices.getUserMedia({
      audio: true,
    });
    const newAudioTrack = newAudioStream.getAudioTracks()[0];
    if (newAudioTrack && streamRef.current) {
      streamRef.current.addTrack(newAudioTrack);
      setAudioEnabled(true);
    }
  } catch (err) {
    /* console.error("마이크 시작 실패:", err); */
  }
};
```

### 배운 점

- MediaStream에서 트랙을 `removeTrack()`으로 제거하고 `stop()`으로 정지해야 리소스 해제됨
- 새로운 스트림을 만들어서 기존 스트림에 `addTrack()`으로 추가 가능
- 하드 토글과 소프트 토글의 차이를 명확히 구분해야 함

## Zustand 상태 관리로 컴포넌트 간 데이터 공유

### 상황

- `cameraStore.js`에서 카메라 상태들을 전역으로 관리
- 여러 컴포넌트에서 카메라 상태를 공유해야 함

### cameraStore 구조

```js
const useCameraStore = create(
  persist(
    (set, get) => ({
      // 상태
      isVideoEnabled: true,
      isAudioEnabled: true,
      localStream: null,
      transparency: 80,
      cameraMode: 1, // FULL, PERSON_ONLY, FACE_ONLY

      // 액션
      setVideoEnabled: (enabled) => set({ isVideoEnabled: enabled }),
      setLocalStream: (stream) => set({ localStream: stream }),
      setTransparency: (value) => set({ transparency: value }),
    }),
    {
      name: "camera-store",
      storage: createJSONStorage(() => sessionStorage),
    }
  )
);
```

### 컴포넌트에서 사용

```js
// RoomInfo.jsx에서
const {
  isVideoEnabled: isCameraOn,
  localStream,
  setVideoEnabled,
} = useCameraStore();
```

### 배운 점

- Zustand의 `persist`로 새로고침해도 상태 유지
- MediaStream 같은 객체는 직렬화 불가하므로 persist에서 제외
- 필요한 상태만 선택적으로 구독하여 불필요한 리렌더링 방지
