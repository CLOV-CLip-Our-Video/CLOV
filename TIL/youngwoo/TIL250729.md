# TIL - 2025ë…„ 7ì›” 29ì¼

## WebSocket ì—°ê²° ë° ì´ë²¤íŠ¸ ì²˜ë¦¬ êµ¬ì¡°

### socket.js ì„œë¹„ìŠ¤ êµ¬ì¡°

- WebSocket ì—°ê²°ì„ ì „ì—­ì—ì„œ ê´€ë¦¬í•˜ëŠ” ì„œë¹„ìŠ¤ íŒŒì¼
- ë‹¨ì¼ ì†Œì¼“ ì¸ìŠ¤í„´ìŠ¤ë¡œ ì¤‘ë³µ ì—°ê²° ë°©ì§€
-

```js
// socket.js
let socket = null;

export const connectWebSocket = (
  roomCode,
  clientId,
  onMessageCallback,
  onOpenCallback
) => {
  if (socket && socket.readyState === WebSocket.OPEN) {
    /* console.warn("ğŸ” ì´ë¯¸ ì—´ë¦° WebSocket ì—°ê²° ì¡´ì¬. ì¬ì‚¬ìš©"); */
    return;
  }

  const url = `wss://clov.co.kr/ws?roomCode=${roomCode}&clientId=${clientId}`;
  socket = new WebSocket(url);

  socket.onopen = () => {
    /* console.log("âœ… WebSocket connected"); */
    onOpenCallback?.();
  };

  socket.onmessage = (event) => {
    const message = JSON.parse(event.data);
    onMessageCallback?.(message);
  };
};

export const sendEvent = (event, data) => {
  if (socket && socket.readyState === WebSocket.OPEN) {
    const payload = { event, data };
    socket.send(JSON.stringify(payload));
  }
};
```

### useSocketEvents í›…ìœ¼ë¡œ ì´ë²¤íŠ¸ ë¶„ê¸° ì²˜ë¦¬

```js
// useSocketEvents.js
export default function useSocketEvents() {
  const setAll = useCanvasParticipantsStore(
    (s) => s.setAllParticipantsFromSync
  );
  const updateOne = useCanvasParticipantsStore((s) => s.updateParticipantState);

  return function handleSocketMessage(message) {
    const { event, data } = message;

    switch (event) {
      case "user-joined":
        const newParticipants = Object.entries(data.participants).map(
          ([id, nickname]) => ({ clientId: id, nickname, x: 100, y: 100 })
        );
        setAll(newParticipants);
        break;

      case "user-left":
        // ì°¸ì—¬ì ì œê±° ë¡œì§
        break;
    }
  };
}
```

### ë°°ìš´ ì 

- WebSocket ì—°ê²° ìƒíƒœ ì²´í¬ë¡œ ì¤‘ë³µ ì—°ê²° ë°©ì§€
- ì´ë²¤íŠ¸ ì²˜ë¦¬ ë¡œì§ì„ ë³„ë„ í›…ìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ì¬ì‚¬ìš©ì„± í–¥ìƒ
- ì½œë°± í•¨ìˆ˜ë¡œ ì»´í¬ë„ŒíŠ¸ë³„ ì²˜ë¦¬ ë¡œì§ ë¶„ë¦¬

## useRoomEntry í›…ìœ¼ë¡œ ë°© ì…ì¥ ë¡œì§ ë¶„ë¦¬

### ê¸°ì¡´ ë¬¸ì œ

- ë°© ìƒì„±/ì…ì¥ ë¡œì§ì´ ì»´í¬ë„ŒíŠ¸ì— ì§ì ‘ ì‘ì„±ë˜ì–´ ìˆìŒ
- API í˜¸ì¶œê³¼ WebSocket ì—°ê²°ì´ ì„ì—¬ì„œ ë³µì¡í•¨

### useRoomEntry.js êµ¬ì¡°

```js
const useRoomEntry = () => {
  const navigate = useNavigate();
  const [isEntering, setIsEntering] = useState(false);
  const { setRoomCode, setClientId, setIsHost } = useRoomStore();

  const handleEnterRoom = async () => {
    setIsEntering(true);

    try {
      // 1. API í˜¸ì¶œë¡œ ë°© ì…ì¥
      const response = await joinRoom(roomCode, nickname);

      // 2. ìƒíƒœ ì—…ë°ì´íŠ¸
      setClientId(response.clientId);
      setIsHost(response.isHost);

      // 3. WebSocket ì—°ê²°
      connectWebSocket(roomCode, response.clientId, onMessage);

      // 4. í˜ì´ì§€ ì´ë™
      navigate(`/recording/${roomCode}`);
    } catch (error) {
      /* console.error("ë°© ì…ì¥ ì‹¤íŒ¨:", error); */
    } finally {
      setIsEntering(false);
    }
  };

  return { handleEnterRoom, isEntering };
};
```

### ë°°ìš´ ì 

- ë³µì¡í•œ ë¡œì§ì„ ì»¤ìŠ¤í…€ í›…ìœ¼ë¡œ ë¶„ë¦¬í•˜ë©´ ê°€ë…ì„±ê³¼ ì¬ì‚¬ìš©ì„± í–¥ìƒ
- API í˜¸ì¶œ â†’ ìƒíƒœ ì—…ë°ì´íŠ¸ â†’ WebSocket ì—°ê²° â†’ ë„¤ë¹„ê²Œì´ì…˜ ìˆœì„œ ì¤‘ìš”
- ë¡œë”© ìƒíƒœ ê´€ë¦¬ë¡œ ì‚¬ìš©ì ê²½í—˜ ê°œì„ 
