# TIL - 2025년 7월 23일

## 카메라 스트림 연결 문제 해결

### 문제 상황

- `useCamera` 훅에서 `getUserMedia()`로 스트림을 받아왔지만 `<video>` 태그에 화면이 출력되지 않음
- 콘솔에 다음 경고 출력:
  ```
  [useCamera] getUserMedia 성공: MediaStream
  [useCamera] videoRef가 유효하지 않음
  ```

### 원인 분석

- `<video>`의 DOM 요소가 아직 마운트되기 전에 `videoRef.current.srcObject = stream`을 호출함
- 이로 인해 `videoRef.current`는 `null`인 상태 → 스트림이 연결되지 않음

### 해결 방법

- `<video>`가 DOM에 렌더링되고 나서 스트림을 연결해야 하므로, `videoRef`와 `currentStream`이 모두 유효할 때 연결하도록 `useEffect` 분리

```tsx
useEffect(() => {
  if (videoRef.current && currentStream) {
    /* console.log("[useCamera] videoRef 준비됨 → 스트림 연결"); */
    videoRef.current.srcObject = currentStream;
  }
}, [currentStream]);
```

- 기존 `startCamera()` 안에서 `videoRef.current.srcObject = stream` 부분은 제거

### 오늘 배운 것 정리

- `ref.current`는 렌더링 후에만 DOM 요소를 참조할 수 있으므로, 초기화 시점에 접근하면 `null`일 수 있음
- MediaStream을 `<video>`에 연결할 때는 반드시 DOM이 준비된 후 연결해야 안전
- `useEffect`를 통해 `videoRef.current`와 `MediaStream`이 모두 유효할 때 연결하는 것이 안정적
- React의 `useRef`는 리렌더를 유발하지 않으므로, 의존성 배열에 `ref` 자체는 넣을 필요 없음 (`ref.current` 변화는 트래킹되지 않음)

### 🛠 리팩토링 요약

| 항목             | 변경 전                    | 변경 후                      |
| ---------------- | -------------------------- | ---------------------------- |
| 스트림 연결 위치 | `startCamera()` 내부       | `useEffect([currentStream])` |
| 에러 로그        | `videoRef가 유효하지 않음` | 사라짐                       |
| 결과             | 카메라 화면 정상 출력      | ✅                           |
