# TIL - 2025년 8월 5일

## 오늘 배운 점: WebSocket & Room 검증 로직 개선

### 배경

- 기존 구조에서는 **방 유효성 검증 전에** `join-room` WebSocket 이벤트가 먼저 발송되는 문제가 있었음
- 잘못된 URL 직접 접근 시에도 소켓이 연결되는 비정상 흐름 발생
- `leave-room` 이벤트가 여러 번 발송되거나, 새로고침/뒤로가기 시 누락되는 경우가 있었음
-

### 오늘 한 작업 & 배운 것

1. **방 유효성 검증 후 소켓 연결**

   - URL 직접 접근 시 무조건 검증 API 호출 → 성공 시에만 WebSocket 연결 & `join-room` 발송
   - 덕분에 무단 접근 차단 가능

2. **`leave-room` 호출 조건 개선**

   - 언마운트 시 무조건 호출하는 방식 → 조건부 호출로 변경
   - 불필요한 중복 API 호출 방지

3. **검증 상태 리셋 로직 추가**
   - 검증이 끝난 후 내부 상태를 다시 초기화
   - 다음 진입 시에도 항상 정상적인 검증이 동작하도록 함

### 배운 점

- **검증 → 연결 → 이벤트 발송** 순서를 지키면 흐름이 깔끔해진다
- `leave-room`는 모든 이탈 케이스(뒤로가기, 새로고침, 브라우저 닫기)를 고려해서 처리해야 한다
- 상태 플래그는 다음 마운트에서도 동작할 수 있도록 리셋이 필요하다

### 앞으로 보완할 점

- `beforeunload` 이벤트와 `navigator.sendBeacon()`을 활용해 **브라우저 종료 시에도 `leave-room` 보장**
- 검증 상태 초기화 시점을 더 안정적으로 제어하는 패턴 도입
