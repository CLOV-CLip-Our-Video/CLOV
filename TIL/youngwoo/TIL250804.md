# TIL - 2025년 8월 4일

## WebSocket 연결 시점 안정화

### 1. 문제 상황

- 방 생성/참여 직후 `join-room` 이벤트가 서버에 도착하지 않는 현상 발생
- 참가자 목록에 뜨지 않거나, 유령 유저처럼 남아있는 문제 확인
- 재입장 시 충돌, 퇴장 이벤트 누락 등 부가적인 오류 동반
- ***

### 2. 원인 분석

- **연결 시점 문제**
  - API 응답 전 `connectWebSocket` 실행 → `roomCode`·`clientId` 값이 없는 상태에서 연결
  - 서버 세션 등록 이전에 `join-room` 전송 → 패킷이 무시됨
- **이벤트 전송 타이밍**
  - WebSocket `onopen` 이전에 이벤트 송신 → 초기화가 완료되지 않아 서버에서 처리 불가

---

### 3. 해결 방법

- **연결 순서 재설계**
  - 기존: 버튼 클릭 → WebSocket 연결 → API 요청 → 응답 처리
  - 변경: 버튼 클릭 → API 요청 → 응답(roomCode, clientId 확보) → WebSocket 연결 → `join-room` 송신
- **가드 로직 추가**
  ```js
  if (!roomCode || !clientId) {
    /* console.warn("❌ WebSocket 연결 차단: 필수 데이터 없음"); */
    return;
  }
  ```
- **`onopen` 보장 후 이벤트 송신**
  - WebSocket `onopen` 이벤트 발생 후에만 `join-room` 호출

---

### 4. 개선 결과

- `join-room` 이벤트 도착률 100% 확보
- 유령 유저, 참가자 목록 누락 현상 해소
- 퇴장 처리(`leave-room` + REST API `DELETE /members/{clientId}`) 정상 동작
- 재입장 시 충돌 없이 정상 연결

---

## 배운 점

- WebSocket 연결과 준비 상태는 다르다. 연결이 열렸다고 바로 전송하면 안 된다.
- REST API와 WebSocket을 함께 사용할 경우 **API → WebSocket 순서**가 안정성을 좌우한다.
- `onopen` 이전 송신은 TCP 소켓 시절의 “데이터 흘림” 문제와 동일하게 동작한다.
- 실시간 서비스에서는 **연결 타이밍 제어**가 안정화의 핵심이다.
