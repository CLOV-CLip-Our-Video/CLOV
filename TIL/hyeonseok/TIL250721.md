# 2025-07-21 TIL

## 동영상, 사진 파일 형식 결정
크롬은 기본적으로 webm 을 사용한다. 하지만 mp4는 호환성이 좋다는 장점이 있다. 우리는 모바일 웹 배포도 고려하고 있고, iPhone은 Webkit을 강제하기 때문에 혹시 모를 리스크를 대비해 mp4로 동영상을 저장하는 것이 적합하다고 생각했다. 그리고 서버에 파일을 저장해도 30분 ~ 1시간 정도의 유효시간을 정해둘 것이라 용량 문제가 크리티컬하지 않다고 판단해 이미지는 JPEG 보다는 PNG가 사용자 경험 측면에서 더 좋다고 판단했다.

---
## 공유 방식 결정
**링크 공유**와 **파일 직접 공유** 중 **링크 공유** 방식이 적합하다고 판단했다. 후자는 구현 난이도가 높아서 빠른 배포가 중요한 우리에게는 맞지 않다. 각 플랫폼별 API가 필요하고, 카카오톡 파일 업로드 API가 복잡한 편이다. 인스타그램은 심지어 직접 파일 공유가 불가능하다. 링크 공유는 가볍고 빠르며 구현 난이도가 쉽다. 또한 통계 수집도 가능하다.

---
## 영상 데이터 전달 방식
웹에서는 **보안상 파일을 직접 접근할 수 없다.** 브라우저가 내 컴퓨터 파일에 막 접근하면 위험하다. 악성 사이트가 다른 사이트 데이터를 훔치는 것도 위험하다. 웹페이지와 데스크톱 앱의 파일 시스템을 격리하기 위해 파일 직접 접근이 불가능하다. 그래서 브라우저에게 "이 영상을 어떻게 가져와서 재생해라"라고 알려줘야 한다.
### 1. Blob (Binary Large Object)
브라우저 메모리에 임시로 저장된 파일 덩어리
```javascript
// WebRTC로 녹화 완료 시
const mediaRecorder = new MediaRecorder(stream);
mediaRecorder.ondataavailable = (event) => {
  const videoBlob = new Blob([event.data], { type: 'video/mp4' });
  const videoUrl = URL.createObjectURL(videoBlob); // blob:http://localhost:3000/abc-123-def
};
```
**장점:**
- 메모리 효율적 (필요할 때만 로드)
- WebRTC 녹화와 자연스럽게 연결
- 브라우저 네이티브 지원 (가장 빠름)
- 다운로드도 쉬움
**단점:**
- 새로고침하면 사라짐(Blob 객체는 브라우저 RAM 에만 존재한다. 새로고침을 하면 RAM 이 초기화되면서 Blob이 사라진다)
- 다른 기기에서 볼 수 없음

### 2. Base64 인코딩
이진 데이터를 텍스트로 변환 (이메일 첨부파일의 방식이 이것이다)
```javascript
// Blob을 Base64로 변환
const reader = new FileReader();
reader.onload = () => {
  const base64 = reader.result; // "data:video/mp4;base64,UklGRnoGAAB..."
};
reader.readAsDataURL(videoBlob);
```
**장점:**
- JSON 으로 전송 가능
- DB 에 직접 저장 가능
- 네트워크 상관없이 안정적
**단점:**
- 파일 크기가 대략 33% 증가
- 메모리 많이 사용(느림)
- 긴 문자열 처리 복잡

### 3. 서버 URL
서버에 파일 저장 후 접근 주소 제공
```javascript
// 1. 서버에 업로드
const formData = new FormData();
formData.append('video', videoBlob);
const response = await fetch('/api/upload', { method: 'POST', body: formData });

// 2. 서버에서 URL 받기
const { videoUrl } = await response.json(); // "https://api.clov.com/videos/abc123.mp4"
```
**장점:**
- 가장 효율적 (파일 한 번만 저장)
- 여러 기기에서 접근 가능
- 캐싱 가능 (빠른 재접속)
**단점:**
- 서버 저장소 필요
- 업로드 시간 필요
- 네트워크 의존적

우리 프로젝트는 클라이언트 녹화, 임시 저장, 30분 ~ 1시간 후 삭제, 로컬 다운로드 위주, 30초 내외 영상이기 때문에 **Blob + 선택적 서버 업로드** 방식이 적합하다고 판단했다. 
```javascript
// 1단계: WebRTC 녹화 → Blob 생성
const recordedBlob = new Blob([videoData], { type: 'video/mp4' });
const localVideoUrl = URL.createObjectURL(recordedBlob);

// 2단계: 즉시 미리보기 (Blob 사용)
<video src={localVideoUrl} />

// 3단계: 공유 필요시만 서버 업로드
if (needToShare) {
  const serverUrl = await uploadToServer(recordedBlob);
  setShareUrl(serverUrl);
}
```