# 2025년 7월 28일 TIL

얼굴 누끼를 따는 기능을 구현하다 여러 문제가 발생했다.

## 무한 렌더링 문제 (Maximum update depth exceeded)
**문제:** useEffect의 의존성 배열로 인한 무한 렌더링
```jsx
// 문제가 있는 코드
useEffect(() => {
	// 함수들이 매번 새로 생성되어 의존성이 계속 변경됨
}, [onStateChange, cleanup, initializeAIModles]);

// 해결된 코드
useEffect(() => {
	// 필요한 상태값만 의존성에 포함
}, [segmentationMode, isInitialized]);
```
**원인:**
- 콜백 함수들이 매 렌더링마다 새로 생성
- useCallback 으로 감싸도 의존성이 계속 변경
- modeInfo 객체가 매번 새로 생성
**해결:**
- 의존성 배열에서 함수 제거
- useMemo로 객체 메모이제이션
- 필수 상태값만 의존성에 포함

## 누끼 모드 전환 시 캔버스 멈춤
**문제:** 모드 변경 시 전체 AI 모델 재초기화로 인한 프레임 처리 중단
**원인:**
```jsx
// ❌ 문제가 있던 구조
useEffect(() => {
  // 모드 변경 시마다 전체 초기화
  cleanup();
  initializeAIModels();
}, [segmentationMode]);
```
**해결:**
```jsx
// ✅ 개선된 구조
useEffect(() => {
  // 최초 1회만 MediaPipe 초기화
  if (!selfieSegmentationRef.current) {
    initializeAIModels();
  }
}, []);

useEffect(() => {
  // 얼굴 모드 전환 시에만 BlazeFace 로딩
  if (segmentationMode === 'face' && !blazefaceModelRef.current) {
    loadBlazeFace();
  }
}, [segmentationMode]);
```
